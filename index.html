<!DOCTYPE html>
<html>
<head>
<style>
  body {
    margin: 0;
    background-color: #0D0208;
  }

  .container {
    background-color: #0D0208;
    width: 100vw;
    height: 100vh;
  }

  .letter {
    font-size: 2em;
  }
</style>
  <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
<script>
const getCharacterSet = () => {
  // start with 0 - 9
  const characters = [48, 49, 50, 51, 52, 53, 54, 55, 56, 57];

  // Hiragana
  // 3041— 309F
  const hiraganaMin = parseInt('3041', 16);
  const hiraganaMax = parseInt('309F', 16);

  for (let i = hiraganaMin; i <= hiraganaMax; i++) {
    characters.push(i);
  }

  // Katakana
  // 30A0— 30FF
  const katakanaMin = parseInt('30A0', 16);
  const katakanaMax = parseInt('30FF', 16);

  for (let i = katakanaMin; i <= katakanaMax; i++) {
    characters.push(i);
  }

  return characters;
};

const charMap = getCharacterSet();

const getRandomCharacter = () => {
  const index = Math.floor(Math.random() * (charMap.length - 1));
  return String.fromCodePoint(charMap[index]);
};

const svg = d3.select('body')
  .append('svg')
  .attr('class', 'container');

const charSize = {
  width: 32,
  height: 32,
};

let svgSize = svg.node().getBoundingClientRect();
let maxVisibleChars = (svgSize.width * svgSize.height) / (charSize.width * charSize.height);
let maxVisibleCharsAllowed = Math.floor(maxVisibleChars * 0.50);

const getHorizontalSlots = () => {
  return Math.ceil(svgSize.width / charSize.width);
};

let horizontalSlots = getHorizontalSlots();

// reset variables depending on the container size
d3.interval(() => {
  const newSvgSize = svg.node().getBoundingClientRect();

  if (newSvgSize.width !== svgSize.width || newSvgSize.height !== svgSize.height) {
    console.log('yes');
    svgSize = newSvgSize;
    maxVisibleChars = (svgSize.width * svgSize.height) / (charSize.width * charSize.height);
    maxVisibleCharsAllowed = Math.floor(maxVisibleChars * 0.50);
    horizontalSlots = getHorizontalSlots();
  }

  // look at the DOM to see if there are too many elements. If so, remove them.
  const elms = document.getElementsByTagName('text');
  const leftoverDomCount = elms.length - maxVisibleCharsAllowed;

  if (leftoverDomCount > 0) {
    for (let i = leftoverDomCount; i >= 0; i--) {
        elms[i].remove();
    }
  }
}, 500);

const placeText = (char, x, y) => {
  const letter = svg.append('text')
    .attr('class', 'letter')
    .attr('fill', '#E6FFEC')
    .attr('text-anchor', 'middle')
    .attr('transform', 'scale(-1, 1)')
    .attr('x', -x)
    .attr('y', y)
    .attr('opacity', 1)
    .text(char);
  
  letter
    .transition()
      .duration(100)
      .attr('fill', '#00FF41')
    .transition()
      .duration(10)
      .attr('fill', '#008F11');
  
  d3.timeout(() => {
    letter.transition()
      .duration(750)
      .attr('fill', '#003B00');
  }, Math.floor(Math.random() * 3000));
  
  d3.timeout(() => {
    letter.transition()
      .duration(750)
      .attr('fill', '#002300');
  }, Math.floor(Math.random() * 4000));
  
  d3.timeout(() => {
    letter.transition()
      .duration(750)
      .attr('opacity', 0)
      .remove();
  }, Math.floor(Math.random() * 10000));
};

const loop = () => {
  let verticalCounter = Math.floor(Math.random() * 15);
  let horizontalSlot = Math.floor(Math.random() * horizontalSlots);
  
  return () => {
    placeText(
      getRandomCharacter(),
      charSize.width * horizontalSlot,
      charSize.height * verticalCounter);

    verticalCounter++;

    if (charSize.height * verticalCounter > svgSize.height) {
      verticalCounter = Math.floor(Math.random() * 5);
      horizontalSlot = Math.floor(Math.random() * horizontalSlots);
    }
  };
};

const a = loop();
const b = loop();
const c = loop();

d3.interval(a, Math.floor(100 + Math.random() * 50));
d3.interval(b, Math.floor(100 + Math.random() * 50));
d3.interval(c, Math.floor(100 + Math.random() * 50));
</script>
</body>
</html>